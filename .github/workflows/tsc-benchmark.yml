name: TSC Benchmark

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmark/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmark/**'
  workflow_dispatch:
    inputs:
      full_suite:
        description: 'Run full benchmark suite (including VSCode)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: tsc-benchmark-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tsc-benchmark:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup EdgeBox
        uses: ./.github/actions/setup-edgebox

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install benchmark dependencies
        run: |
          cd benchmark
          npm install

      - name: Build EdgeBox compiler
        run: zig build cli -Doptimize=ReleaseFast

      - name: Compile tsc with EdgeBox AOT
        run: |
          ./zig-out/bin/edgeboxc --binary-only --allocator=arena benchmark/node_modules/typescript/lib/tsc.js

      - name: Install tsgo (TypeScript Native Preview)
        continue-on-error: true
        run: |
          # Install Microsoft's tsgo (Go-based TypeScript compiler)
          npm install -g @typescript/native-preview || echo "tsgo not available"
          which tsgo || echo "tsgo not in PATH"

      - name: Run TSC Benchmark (Quick)
        if: ${{ github.event.inputs.full_suite != 'true' }}
        run: |
          cd benchmark
          npx tsx run.ts --no-vscode --runs 3 --include-tsgo

      - name: Run TSC Benchmark (Full)
        if: ${{ github.event.inputs.full_suite == 'true' }}
        run: |
          cd benchmark
          npx tsx run.ts --runs 3 --include-tsgo

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: tsc-benchmark-results
          path: benchmark/results.json
          if-no-files-found: ignore

      - name: Generate Summary
        run: |
          echo "# TSC Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Using Microsoft's tsgo benchmark projects (rxjs, trpc, date-fns, typeorm, playwright)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f benchmark/results.json ]; then
            # Parse JSON and generate table with optional tsgo column
            node -e "
              const results = require('./benchmark/results.json');
              const hasTsgo = results.some(r => r.tsgoMean !== undefined);

              if (hasTsgo) {
                console.log('| Project | Lines | Node.js (ms) | EdgeBox (ms) | Speedup | tsgo (ms) | tsgo Speedup | Match |');
                console.log('|---------|-------|--------------|--------------|---------|-----------|--------------|-------|');
              } else {
                console.log('| Project | Lines | Node.js (ms) | EdgeBox (ms) | Speedup | Match |');
                console.log('|---------|-------|--------------|--------------|---------|-------|');
              }

              let totalLines = 0;
              let totalSpeedup = 0;
              let totalTsgoSpeedup = 0;
              let tsgoCount = 0;
              let allMatch = true;

              for (const r of results) {
                const lines = r.lines.toLocaleString();
                const node = r.nodeMean.toFixed(0);
                const edgebox = r.edgeboxMean.toFixed(0);
                const speedup = r.speedup.toFixed(2);
                const match = r.outputMatch ? '✓' : '✗';

                if (hasTsgo) {
                  const tsgo = r.tsgoMean !== undefined ? r.tsgoMean.toFixed(0) : '-';
                  const tsgoSpd = r.tsgoSpeedup !== undefined ? r.tsgoSpeedup.toFixed(2) + 'x' : '-';
                  console.log('| ' + r.project + ' | ' + lines + ' | ' + node + ' | ' + edgebox + ' | ' + speedup + 'x | ' + tsgo + ' | ' + tsgoSpd + ' | ' + match + ' |');
                  if (r.tsgoSpeedup !== undefined) {
                    totalTsgoSpeedup += r.tsgoSpeedup;
                    tsgoCount++;
                  }
                } else {
                  console.log('| ' + r.project + ' | ' + lines + ' | ' + node + ' | ' + edgebox + ' | ' + speedup + 'x | ' + match + ' |');
                }

                totalLines += r.lines;
                totalSpeedup += r.speedup;
                if (!r.outputMatch) allMatch = false;
              }

              const avgSpeedup = (totalSpeedup / results.length).toFixed(2);
              const avgTsgoSpeedup = tsgoCount > 0 ? (totalTsgoSpeedup / tsgoCount).toFixed(2) + 'x avg' : '-';
              const totalMatch = allMatch ? '✓' : '✗';

              if (hasTsgo) {
                console.log('|---------|-------|--------------|--------------|---------|-----------|--------------|-------|');
                console.log('| **TOTAL** | ' + totalLines.toLocaleString() + ' | | | ' + avgSpeedup + 'x avg | | ' + avgTsgoSpeedup + ' | ' + totalMatch + ' |');
              } else {
                console.log('|---------|-------|--------------|--------------|---------|-------|');
                console.log('| **TOTAL** | ' + totalLines.toLocaleString() + ' | | | ' + avgSpeedup + 'x avg | ' + totalMatch + ' |');
              }
            " >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✓ = Output matches Node.js tsc" >> $GITHUB_STEP_SUMMARY
          else
            echo "_Results not available_" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Output Correctness
        run: |
          if [ -f benchmark/results.json ]; then
            node -e "
              const results = require('./benchmark/results.json');
              const mismatches = results.filter(r => !r.outputMatch);
              if (mismatches.length > 0) {
                console.error('Output mismatches detected:');
                for (const r of mismatches) {
                  console.error('  ' + r.project + ': ' + r.outputDiff);
                }
                process.exit(1);
              }
              console.log('All outputs match Node.js tsc');
            "
          fi

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## TSC Benchmark Results\n\n';
            body += 'Using Microsoft\'s tsgo benchmark projects.\n\n';

            try {
              const results = JSON.parse(fs.readFileSync('benchmark/results.json', 'utf8'));
              const hasTsgo = results.some(r => r.tsgoMean !== undefined);

              if (hasTsgo) {
                body += '| Project | Lines | Node.js | EdgeBox | Speedup | tsgo | tsgo Speedup | Match |\n';
                body += '|---------|-------|---------|---------|---------|------|--------------|-------|\n';
              } else {
                body += '| Project | Lines | Node.js | EdgeBox | Speedup | Match |\n';
                body += '|---------|-------|---------|---------|---------|-------|\n';
              }

              let totalSpeedup = 0;
              let totalTsgoSpeedup = 0;
              let tsgoCount = 0;
              let allMatch = true;

              for (const r of results) {
                const speedup = r.speedup.toFixed(2);
                const match = r.outputMatch ? ':white_check_mark:' : ':x:';

                if (hasTsgo) {
                  const tsgo = r.tsgoMean !== undefined ? `${r.tsgoMean.toFixed(0)}ms` : '-';
                  const tsgoSpd = r.tsgoSpeedup !== undefined ? `${r.tsgoSpeedup.toFixed(2)}x` : '-';
                  body += `| ${r.project} | ${r.lines.toLocaleString()} | ${r.nodeMean.toFixed(0)}ms | ${r.edgeboxMean.toFixed(0)}ms | ${speedup}x | ${tsgo} | ${tsgoSpd} | ${match} |\n`;
                  if (r.tsgoSpeedup !== undefined) {
                    totalTsgoSpeedup += r.tsgoSpeedup;
                    tsgoCount++;
                  }
                } else {
                  body += `| ${r.project} | ${r.lines.toLocaleString()} | ${r.nodeMean.toFixed(0)}ms | ${r.edgeboxMean.toFixed(0)}ms | ${speedup}x | ${match} |\n`;
                }

                totalSpeedup += r.speedup;
                if (!r.outputMatch) allMatch = false;
              }

              const avgSpeedup = (totalSpeedup / results.length).toFixed(2);
              const avgTsgoSpeedup = tsgoCount > 0 ? (totalTsgoSpeedup / tsgoCount).toFixed(2) : null;

              let summary = `**EdgeBox speedup: ${avgSpeedup}x**`;
              if (avgTsgoSpeedup) {
                summary += ` | **tsgo speedup: ${avgTsgoSpeedup}x**`;
              }
              summary += allMatch ? ' :white_check_mark: All outputs match' : ' :x: Some outputs differ';
              body += `\n${summary}\n`;

            } catch (e) {
              body += '_Results not available_\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
