name: Test262 Comparison

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 0'  # Weekly on Sunday

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test262:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours - unlimited for open source
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install LLVM for WAMR AOT compiler
        run: sudo apt-get install -y llvm-18-dev

      - name: Cache WAMR build
        uses: actions/cache@v4
        with:
          path: vendor/wamr/product-mini/platforms/linux/build
          key: wamr-linux-${{ hashFiles('vendor/wamr/core/version.h', 'vendor/wamr/product-mini/platforms/linux/CMakeLists.txt', 'scripts/build-wamr.sh') }}

      - name: Build WAMR
        run: ./scripts/build-wamr.sh

      - name: Clone test262
        run: |
          cd vendor/quickjs-ng
          git clone --depth 1 https://github.com/tc39/test262.git

      - name: Build EdgeBox for test262
        run: |
          zig build wasm -Doptimize=ReleaseFast
          zig build runner -Doptimize=ReleaseFast
          zig build test262 -Doptimize=ReleaseFast

      - name: Build QuickJS-NG
        working-directory: vendor/quickjs-ng
        run: make qjs

      - name: Add EdgeBox and QJS to PATH
        run: |
          echo "$PWD/zig-out/bin" >> $GITHUB_PATH
          echo "$PWD/vendor/quickjs-ng/build" >> $GITHUB_PATH

      # Run SAME tests on all four engines using edgebox-test262

      - name: Run test262 - EdgeBox (1st)
        run: |
          START=$(date +%s)
          ./zig-out/bin/edgebox-test262 \
            --engine=edgebox \
            --harness=vendor/quickjs-ng/test262/harness \
            vendor/quickjs-ng/test262/test/language/ \
            > results-edgebox.txt 2>&1 || true
          END=$(date +%s)
          echo "EDGEBOX_TIME=$((END-START))" >> $GITHUB_ENV

      - name: Run test262 - QuickJS-NG (2nd)
        run: |
          START=$(date +%s)
          ./zig-out/bin/edgebox-test262 \
            --engine=qjs \
            --harness=vendor/quickjs-ng/test262/harness \
            vendor/quickjs-ng/test262/test/language/ \
            > results-qjs.txt 2>&1 || true
          END=$(date +%s)
          echo "QJS_TIME=$((END-START))" >> $GITHUB_ENV

      - name: Run test262 - Node.js (3rd)
        run: |
          START=$(date +%s)
          ./zig-out/bin/edgebox-test262 \
            --engine=node \
            --harness=vendor/quickjs-ng/test262/harness \
            vendor/quickjs-ng/test262/test/language/ \
            > results-node.txt 2>&1 || true
          END=$(date +%s)
          echo "NODE_TIME=$((END-START))" >> $GITHUB_ENV

      - name: Run test262 - Bun (4th)
        run: |
          START=$(date +%s)
          ./zig-out/bin/edgebox-test262 \
            --engine=bun \
            --harness=vendor/quickjs-ng/test262/harness \
            vendor/quickjs-ng/test262/test/language/ \
            > results-bun.txt 2>&1 || true
          END=$(date +%s)
          echo "BUN_TIME=$((END-START))" >> $GITHUB_ENV

      - name: Generate Comparison Summary
        run: |
          echo "# Test262 Comparison - All Engines" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Using the same test suite (\`vendor/quickjs-ng/test262/test/language/\`) for fair comparison." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Engine | Time (seconds) |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| EdgeBox | $EDGEBOX_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "| QuickJS-NG | $QJS_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | $NODE_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "| Bun | $BUN_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Engine | Passed | Failed | Skipped | Pass Rate |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|--------|---------|-----------|" >> $GITHUB_STEP_SUMMARY

          # Extract results from each engine
          for engine in edgebox qjs node bun; do
            if [ -f "results-${engine}.txt" ]; then
              passed=$(grep "^passed:" "results-${engine}.txt" | cut -d: -f2 | tr -d ' ' || echo "?")
              failed=$(grep "^failed:" "results-${engine}.txt" | cut -d: -f2 | tr -d ' ' || echo "?")
              skipped=$(grep "^skipped:" "results-${engine}.txt" | cut -d: -f2 | tr -d ' ' || echo "?")
              pass_rate=$(grep "^pass_rate:" "results-${engine}.txt" | cut -d: -f2 | tr -d ' ' || echo "?")
              echo "| ${engine} | ${passed} | ${failed} | ${skipped} | ${pass_rate} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${engine} | - | - | - | - |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Detailed Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for engine in edgebox qjs node bun; do
            echo "### ${engine}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            if [ -f "results-${engine}.txt" ]; then
              head -30 "results-${engine}.txt" >> $GITHUB_STEP_SUMMARY
            else
              echo "No results available" >> $GITHUB_STEP_SUMMARY
            fi
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - uses: actions/upload-artifact@v4
        with:
          name: test262-results
          path: results-*.txt
          retention-days: 90
