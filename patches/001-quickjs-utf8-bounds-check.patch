--- a/quickjs.c
+++ b/quickjs.c
@@ -20544,10 +20544,11 @@ static int js_parse_template_part(JSParseState *s, const uint8_t *p)
             /* line terminator */
             s->eol = &p[-1];
             s->mark = p;
         } else if (c >= 0x80) {
-            c = utf8_decode(p - 1, &p_next);
+            size_t remain = (p - 1 < s->buf_end) ? (size_t)(s->buf_end - (p - 1)) : 0;
+            c = utf8_decode_len(p - 1, remain, &p_next);
             if (p_next == p) {
                 js_parse_error(s, "invalid UTF-8 sequence");
                 goto fail;
@@ -20653,10 +20654,11 @@ static int js_parse_string(JSParseState *s, int sep,
                     }
                     goto fail;
                 } else if (c >= 0x80) {
-                    c = utf8_decode(p, &p_next);
+                    size_t remain = (p < s->buf_end) ? (size_t)(s->buf_end - p) : 0;
+                    c = utf8_decode_len(p, remain, &p_next);
                     if (p_next == p + 1) {
                         goto invalid_utf8;
                     }
@@ -20679,10 +20681,11 @@ static int js_parse_string(JSParseState *s, int sep,
                 break;
             }
         } else if (c >= 0x80) {
-            c = utf8_decode(p - 1, &p_next);
+            size_t remain = (p - 1 < s->buf_end) ? (size_t)(s->buf_end - (p - 1)) : 0;
+            c = utf8_decode_len(p - 1, remain, &p_next);
             if (p_next == p)
                 goto invalid_utf8;
             p = p_next;
