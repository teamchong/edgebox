name: ES2024 Compatibility

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 0'  # Weekly on Sunday
  workflow_dispatch:

# Tests ECMAScript 2024 (ES2024) compliance using the official TC39 test262 suite.
# Uses sharded bundled compilation: ~1000 tests per shard, runs in parallel.
# Total time: ~5-10 minutes (vs 20+ hours if compiled individually)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # First job: count tests and determine shards
  setup:
    runs-on: ubuntu-latest
    outputs:
      shards: ${{ steps.calc.outputs.shards }}
      total: ${{ steps.calc.outputs.total }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Ensure submodules are initialized
        run: |
          if [ ! -d "vendor/quickjs-ng/test262/test" ] || [ -z "$(ls -A vendor/quickjs-ng/test262/test)" ]; then
            echo "test262 directory empty, initializing submodules manually..."
            git submodule update --init --recursive
          fi

      - name: Calculate shards
        id: calc
        run: |
          # Count compatible tests (excluding async/module)
          TOTAL=$(find vendor/quickjs-ng/test262/test -name "*.js" ! -name "*_FIXTURE.js" | wc -l | tr -d ' ')
          echo "Total test files: $TOTAL"

          # ~1000 tests per shard, max 50 shards
          TESTS_PER_SHARD=1000
          NUM_SHARDS=$(( (TOTAL + TESTS_PER_SHARD - 1) / TESTS_PER_SHARD ))
          if [ $NUM_SHARDS -gt 50 ]; then
            NUM_SHARDS=50
          fi

          echo "Shards: $NUM_SHARDS"

          # Generate shard array [1,2,3,...,N]
          SHARDS=$(seq 1 $NUM_SHARDS | jq -R . | jq -s -c .)
          echo "shards=$SHARDS" >> $GITHUB_OUTPUT
          echo "total=$NUM_SHARDS" >> $GITHUB_OUTPUT

  # Run each shard in parallel
  test262:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.setup.outputs.shards) }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Ensure submodules are initialized
        run: |
          if [ ! -d "vendor/quickjs-ng/test262/test" ] || [ -z "$(ls -A vendor/quickjs-ng/test262/test)" ]; then
            echo "test262 directory empty, initializing submodules manually..."
            git submodule update --init --recursive
          fi

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup LLVM
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-20 llvm-20-dev clang-20 lld-20
          sudo ln -sf /usr/bin/llvm-config-20 /usr/bin/llvm-config

      - name: Build EdgeBox
        run: zig build -Doptimize=ReleaseFast

      - name: Generate shard bundle
        run: |
          node scripts/bundle-test262.js \
            --shard ${{ matrix.shard }}/${{ needs.setup.outputs.total }} \
            --output zig-out/test262-shard-${{ matrix.shard }}.js

      - name: Compile shard
        run: |
          ./zig-out/bin/edgeboxc --minimal zig-out/test262-shard-${{ matrix.shard }}.js

      - name: Run tests
        id: run
        run: |
          BINARY="./zig-out/bin/zig-out/test262-shard-${{ matrix.shard }}.js/test262-shard-${{ matrix.shard }}"
          OUTPUT=$($BINARY 2>&1) || true
          echo "$OUTPUT"

          # Extract JSON
          JSON=$(echo "$OUTPUT" | sed -n '/__TEST262_JSON_START__/,/__TEST262_JSON_END__/p' | grep -v '__TEST262_JSON' || echo '{}')

          if [ -n "$JSON" ] && [ "$JSON" != "{}" ]; then
            PASSED=$(echo "$JSON" | jq -r '.passed // 0')
            FAILED=$(echo "$JSON" | jq -r '.failed // 0')
          else
            PASSED=0
            FAILED=0
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "$JSON" > shard-${{ matrix.shard }}-results.json

      - name: Upload shard results
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard }}-results
          path: shard-${{ matrix.shard }}-results.json

  # Aggregate results from all shards
  aggregate:
    needs: [setup, test262]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*-results
          merge-multiple: true

      - name: Aggregate results
        id: aggregate
        run: |
          TOTAL_PASSED=0
          TOTAL_FAILED=0

          for f in shard-*-results.json; do
            if [ -f "$f" ]; then
              PASSED=$(jq -r '.passed // 0' "$f")
              FAILED=$(jq -r '.failed // 0' "$f")
              TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
              echo "$f: $PASSED passed, $FAILED failed"
            fi
          done

          TOTAL=$((TOTAL_PASSED + TOTAL_FAILED))
          if [ $TOTAL -gt 0 ]; then
            RATE=$((TOTAL_PASSED * 100 / TOTAL))
          else
            RATE=0
          fi

          echo "passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "rate=$RATE" >> $GITHUB_OUTPUT

          # Save combined results
          echo "{\"passed\": $TOTAL_PASSED, \"failed\": $TOTAL_FAILED, \"total\": $TOTAL, \"rate\": $RATE}" > combined-results.json

      - name: Generate Summary
        run: |
          echo "# test262 ES2024 Compatibility Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Passed** | ${{ steps.aggregate.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Failed** | ${{ steps.aggregate.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | ${{ steps.aggregate.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Pass Rate** | ${{ steps.aggregate.outputs.rate }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Shards** | ${{ needs.setup.outputs.total }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: test262-combined-results
          path: combined-results.json
          retention-days: 90

      - name: Check pass rate
        run: |
          RATE=${{ steps.aggregate.outputs.rate }}
          echo "Pass rate: ${RATE}%"

          if [ $RATE -lt 50 ]; then
            echo "::error::Pass rate ${RATE}% is below threshold (50%)"
            exit 1
          fi
